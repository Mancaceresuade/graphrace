<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jugar - Graph Race</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-teal-100 min-h-screen">
    <div class="container mx-auto p-4">
        <div class="bg-white rounded-lg shadow-xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Graph Race</h1>
                <div class="text-sm text-gray-600">
                    <span id="jugadorNombre" class="font-semibold"></span> | 
                    <span id="gameIdDisplay"></span> | 
                    Algoritmo: <span id="algoritmoDisplay"></span>
                </div>
            </div>

            <!-- Panel de estado -->
            <div id="estadoPanel" class="mb-6 p-4 bg-blue-50 rounded-lg">
                <p class="text-blue-800" id="estadoMensaje">Cargando partida...</p>
                <div id="jugadoresLista" class="mt-2 text-sm text-gray-600"></div>
            </div>

            <!-- Canvas para el grafo -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <svg id="grafoSvg" width="100%" height="500" viewBox="0 0 800 500" class="border border-gray-200 rounded-lg bg-white">
                    <!-- Las aristas y nodos se dibujarán aquí -->
                </svg>
            </div>

            <!-- Panel de información -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-700 mb-2">Tu Progreso</h3>
                    <div id="progresoDisplay" class="text-sm text-gray-600">
                        Esperando inicio...
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-700 mb-2">Progreso de Jugadores</h3>
                    <div id="progresoJugadores" class="text-sm text-gray-600">
                        Cargando...
                    </div>
                </div>
            </div>

            <!-- Mensaje de ganador -->
            <div id="ganadorPanel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md mx-4">
                    <h2 class="text-3xl font-bold text-green-600 mb-4 text-center">¡Partida Finalizada!</h2>
                    <p class="text-xl text-center mb-6" id="ganadorMensaje"></p>
                    <p class="text-sm text-center text-gray-600 mb-4">La partida ha terminado.</p>
                    <button onclick="document.getElementById('ganadorPanel').classList.add('hidden')" class="w-full bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">
                        Cerrar
                    </button>
                </div>
            </div>

            <!-- Mensajes del juego -->
            <div id="mensajesPanel" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 hidden">
                <p class="text-yellow-800 text-sm" id="mensajeTexto"></p>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let gameId = null;
        let nombreJugador = null;
        let grafo = null;
        let recorridoCorrecto = null;
        let esAnfitrion = false;
        let juegoIniciado = false;
        let nodosPosiciones = {};

        // Obtener parámetros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        gameId = urlParams.get('gameId');
        nombreJugador = urlParams.get('nombre');

        if (!gameId || !nombreJugador) {
            alert('Parámetros inválidos. Redirigiendo...');
            window.location.href = '/ingresar.html';
        }

        document.getElementById('jugadorNombre').textContent = nombreJugador;
        document.getElementById('gameIdDisplay').textContent = gameId;

        // Conectar WebSocket
        function conectarWebSocket() {
            const socket = new SockJS('/ws/game');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function(frame) {
                console.log('Conectado: ' + frame);
                
                // Suscribirse a los mensajes del juego
                stompClient.subscribe('/topic/game/' + gameId, function(message) {
                    const data = JSON.parse(message.body);
                    manejarMensaje(data);
                });

                // Unirse al juego
                unirseAlJuego();
            }, function(error) {
                console.log('Error de conexión: ' + error);
                mostrarMensaje('Error de conexión. Intentando reconectar...', 'error');
                setTimeout(conectarWebSocket, 3000);
            });
        }

        function unirseAlJuego() {
            const mensaje = {
                type: 'joinGame',
                gameId: gameId,
                nombreJugador: nombreJugador
            };
            stompClient.send('/app/joinGame', {}, JSON.stringify(mensaje));

            // Cargar información del juego
            cargarInformacionJuego();
        }

        async function cargarInformacionJuego() {
            try {
                const response = await fetch(`/api/juego/${gameId}`);
                if (response.ok) {
                    const juego = await response.json();
                    document.getElementById('algoritmoDisplay').textContent = juego.algoritmo;
                    
                    esAnfitrion = juego.nombreAnfitrion === nombreJugador;
                    
                    actualizarListaJugadores(juego.jugadores);
                    
                    // Iniciar el juego automáticamente si no está iniciado
                    if (!juego.iniciado && esAnfitrion) {
                        iniciarPartidaAutomatically();
                    } else if (juego.iniciado) {
                        iniciarJuego(juego);
                    } else {
                        // Si no es anfitrión y el juego no está iniciado, esperar un poco y recargar
                        setTimeout(() => {
                            cargarInformacionJuego();
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('Error al cargar información del juego:', error);
            }
        }

        function iniciarPartidaAutomatically() {
            const mensaje = {
                type: 'startGame',
                gameId: gameId
            };
            stompClient.send('/app/startGame', {}, JSON.stringify(mensaje));
        }

        function iniciarJuego(juego) {
            juegoIniciado = true;
            grafo = juego.grafo || juego.data?.grafo;
            recorridoCorrecto = juego.recorridoCorrecto || juego.data?.recorridoCorrecto;
            
            dibujarGrafo();
            actualizarProgreso();
            mostrarEstado('Selecciona el siguiente nodo del recorrido.');
        }

        function manejarMensaje(data) {
            console.log('Mensaje recibido:', data);
            
            switch(data.type) {
                case 'playerJoined':
                    cargarInformacionJuego();
                    mostrarMensaje(`${data.nombreJugador} se ha unido al juego`, 'info');
                    break;
                    
                case 'gameStarted':
                    if (data.data) {
                        grafo = data.data.grafo;
                        recorridoCorrecto = data.data.recorridoCorrecto;
                        iniciarJuego({ grafo, recorridoCorrecto });
                    }
                    mostrarMensaje('¡La partida ha comenzado!', 'success');
                    break;
                    
                case 'moveCorrect':
                    mostrarMensaje('¡Movimiento correcto!', 'success');
                    actualizarProgreso(data.data?.progreso);
                    dibujarGrafo();
                    break;
                    
                case 'moveIncorrect':
                    mostrarMensaje('Movimiento incorrecto. Intenta otro nodo.', 'error');
                    break;
                    
                case 'winner':
                    mostrarGanador(data.data?.ganador || data.nombreJugador);
                    break;
            }
        }

        function dibujarGrafo() {
            if (!grafo) return;

            const svg = document.getElementById('grafoSvg');
            svg.innerHTML = '';

            // Calcular posiciones de los nodos
            const nodos = Object.keys(grafo);
            const nodosCount = nodos.length;
            const centerX = 400;
            const centerY = 250;
            const radius = 150;

            nodos.forEach((nodo, index) => {
                const angle = (2 * Math.PI * index) / nodosCount - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                nodosPosiciones[nodo] = { x, y };
            });

            // Dibujar aristas
            Object.keys(grafo).forEach(nodo => {
                const adyacentes = grafo[nodo];
                const posOrigen = nodosPosiciones[nodo];
                
                adyacentes.forEach(adyacente => {
                    const posDestino = nodosPosiciones[adyacente];
                    
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', posOrigen.x);
                    line.setAttribute('y1', posOrigen.y);
                    line.setAttribute('x2', posDestino.x);
                    line.setAttribute('y2', posDestino.y);
                    line.setAttribute('stroke', '#94a3b8');
                    line.setAttribute('stroke-width', '2');
                    svg.appendChild(line);
                });
            });

            // Dibujar nodos
            Object.keys(nodosPosiciones).forEach(nodo => {
                const pos = nodosPosiciones[nodo];
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', pos.x);
                circle.setAttribute('cy', pos.y);
                circle.setAttribute('r', 30);
                circle.setAttribute('fill', '#3b82f6');
                circle.setAttribute('stroke', '#1e40af');
                circle.setAttribute('stroke-width', '2');
                circle.setAttribute('cursor', 'pointer');
                circle.setAttribute('class', 'nodo');
                circle.setAttribute('data-nodo', nodo);
                
                circle.addEventListener('click', () => {
                    if (juegoIniciado) {
                        seleccionarNodo(nodo);
                    }
                });
                
                svg.appendChild(circle);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', pos.x);
                text.setAttribute('y', pos.y + 5);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', 'white');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('font-size', '16');
                text.textContent = nodo;
                svg.appendChild(text);
            });

            // Resaltar nodo origen y destino
            if (recorridoCorrecto && recorridoCorrecto.length > 0) {
                const origen = recorridoCorrecto[0];
                const destino = recorridoCorrecto[recorridoCorrecto.length - 1];
                
                const origenCircle = svg.querySelector(`circle[data-nodo="${origen}"]`);
                if (origenCircle) {
                    origenCircle.setAttribute('fill', '#10b981');
                }
                
                const destinoCircle = svg.querySelector(`circle[data-nodo="${destino}"]`);
                if (destinoCircle) {
                    destinoCircle.setAttribute('fill', '#ef4444');
                }
            }
        }

        function seleccionarNodo(nodo) {
            const mensaje = {
                type: 'move',
                gameId: gameId,
                nombreJugador: nombreJugador,
                nodoSeleccionado: nodo
            };
            stompClient.send('/app/move', {}, JSON.stringify(mensaje));
        }

        function actualizarProgreso(progresoData) {
            if (!recorridoCorrecto) return;

            const progresoDisplay = document.getElementById('progresoDisplay');
            const progresoJugadores = document.getElementById('progresoJugadores');
            
            // Obtener progreso actual del jugador
            let miProgreso = 0;
            if (progresoData && progresoData[nombreJugador] !== undefined) {
                miProgreso = progresoData[nombreJugador];
            }

            progresoDisplay.innerHTML = `
                <div class="mb-2">
                    <div class="text-xs text-gray-500 mb-1">Progreso: ${miProgreso} / ${recorridoCorrecto.length - 1}</div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${(miProgreso / (recorridoCorrecto.length - 1)) * 100}%"></div>
                    </div>
                </div>
                <div class="text-xs">
                    <p>Recorrido esperado:</p>
                    <p class="font-mono text-gray-800">${recorridoCorrecto.join(' → ')}</p>
                </div>
            `;

            if (progresoData) {
                let html = '<ul class="space-y-1">';
                Object.keys(progresoData).forEach(jugador => {
                    const progreso = progresoData[jugador];
                    const porcentaje = (progreso / (recorridoCorrecto.length - 1)) * 100;
                    html += `
                        <li class="flex items-center justify-between">
                            <span class="text-xs">${jugador}</span>
                            <div class="flex-1 mx-2 bg-gray-200 rounded-full h-1.5">
                                <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${porcentaje}%"></div>
                            </div>
                            <span class="text-xs text-gray-500">${progreso}</span>
                        </li>
                    `;
                });
                html += '</ul>';
                progresoJugadores.innerHTML = html;
            }
        }

        function actualizarListaJugadores(jugadores) {
            const lista = document.getElementById('jugadoresLista');
            if (jugadores) {
                let nombres;
                if (Array.isArray(jugadores)) {
                    nombres = jugadores;
                } else if (typeof jugadores === 'object') {
                    nombres = Object.keys(jugadores);
                } else {
                    nombres = [];
                }
                
                if (nombres.length > 0) {
                    lista.textContent = `Jugadores: ${nombres.join(', ')}`;
                } else {
                    lista.textContent = 'Esperando jugadores...';
                }
            }
        }

        function mostrarEstado(mensaje) {
            document.getElementById('estadoMensaje').textContent = mensaje;
        }

        function mostrarMensaje(mensaje, tipo) {
            const panel = document.getElementById('mensajesPanel');
            const texto = document.getElementById('mensajeTexto');
            
            panel.className = tipo === 'error' ? 'bg-red-50 border-red-200' : 
                             tipo === 'success' ? 'bg-green-50 border-green-200' : 
                             'bg-blue-50 border-blue-200';
            texto.textContent = mensaje;
            panel.classList.remove('hidden');
            
            setTimeout(() => {
                panel.classList.add('hidden');
            }, 3000);
        }

        function mostrarGanador(ganador) {
            juegoIniciado = false;
            const ganadorPanel = document.getElementById('ganadorPanel');
            const ganadorMensaje = document.getElementById('ganadorMensaje');
            
            if (ganador === nombreJugador) {
                ganadorMensaje.textContent = '¡Has ganado!';
                ganadorMensaje.className = 'text-xl text-center mb-6 text-green-600 font-bold';
            } else {
                ganadorMensaje.textContent = `¡${ganador} ha ganado!`;
                ganadorMensaje.className = 'text-xl text-center mb-6 text-gray-800';
            }
            
            ganadorPanel.classList.remove('hidden');
        }

        // Inicializar conexión al cargar la página
        window.onload = function() {
            conectarWebSocket();
        };
    </script>
</body>
</html>

